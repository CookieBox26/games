<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>計画</title>
<style type="text/css">
html, body {
  margin: 0;
  padding: 0;
}
body {
  background: #505050;
  font-family: sans-serif;
  margin: 8px;
  width: calc(100vw -16px);
  min-width: 360px;
  max-width: 400px;
  line-height: 1.6;
}
input, select {
  border: 1px solid;
  font-size: 18px;
}
.tab-container {
  display: flex;
  gap: 7px;
  justify-content: space-between;
}
.tab-item {
  background-color: #bbbbbb;
  padding: 0.5rem 1rem;
  cursor: pointer;
  user-select: none;
}
.tab-item.active {
  background-color: white;
}
.tab-content {
  background-color: white;
}
.tab-panel {
  padding: 1rem;
  display: none;
}
.tab-panel.active {
  display: block;
}
.text {
  width: 10rem;
}
.num {
  width: 3rem;
}
label {
  display: inline-block;
  width: 4rem;
}
.input-container {
  margin: 0.5rem 0;
  padding: 0.5rem 0.8rem;
}
table {
  border-collapse: collapse;
}
td {
  border: 2px solid black;
  padding: 0.2rem 0.4rem;
}
.hw {
  display: inline-block;
  margin: 0.1rem;
  padding: 0.1rem 0.3rem;
}
.hw-1 {
  background: #96dafc;
}
.hw-2 {
  background: #ffb0a8;
}
.hw-3 {
  background: #fdee73;
}
.hw-4 {
  background: #a0e38a;
}
.date {
  width: 9rem;
}
.warn {
  color: #be0119;
}
.help {
  margin-left: auto;
}
</style>
<body>

<div class="tab-container">
<div class="tab-item active">宿題</div>
<div class="tab-item">計画</div>
<div class="tab-item">予定表</div>
<div class="tab-item help">？</div>
</div>
<div class="tab-content">

<div class="tab-panel active">

<label for="date-start">開始日</label>
<input type="date" id="date-start"/><br/>
<label for="date-end">提出日</label>
<input type="date" id="date-end"/><br/>

<div class="input-container hw-1">
<label for="hw-1-name">宿題1</label>
<input type="text" class="text" id="hw-1-name"/><br/>
<label></label>
<input type="number" min="0" max="200" class="num" id="hw-1-start"/> ～
<input type="number" min="0" max="200" class="num" id="hw-1-end"/> ページ
</div>

<div class="input-container hw-2">
<label for="hw-2-name">宿題2</label>
<input type="text" class="text" id="hw-2-name"/><br/>
<label></label>
<input type="number" min="0" max="200" class="num" id="hw-2-start"/> ～
<input type="number" min="0" max="200" class="num" id="hw-2-end"/> ページ
</div>

<div class="input-container hw-3">
<label for="hw-3-name">宿題3</label>
<input type="text" class="text" id="hw-3-name"/><br/>
<label></label>
<input type="number" min="0" max="200" class="num" id="hw-3-start"/> ～
<input type="number" min="0" max="200" class="num" id="hw-3-end"/> ページ
</div>

<div class="input-container hw-4">
<label for="hw-4-name">宿題4</label>
<input type="text" class="text" id="hw-4-name"/><br/>
<label></label>
<input type="number" min="0" max="200" class="num" id="hw-4-start"/> ～
<input type="number" min="0" max="200" class="num" id="hw-4-end"/> ページ
</div>

</div>

<div class="tab-panel">
<table id="table-keikaku"></table>
</div>

<div class="tab-panel">
<table id="table-yotei"></table>
</div>

<div class="tab-panel">
<ul>
<li>「宿題」タブで開始日・提出日・宿題・ページを入力して、「計画」タブでいつやるか計画してください。</li>
<ul>
<li>提出日には計画を入れられません。</li>
<li>宿題の名前を空欄にするか、開始ページを 0 にすると無視します。</li>
</ul>
<li>計画は端末のブラウザ内 (localStorage) に保存されます。ページを更新しても入力内容が保持されるか確認してからご利用ください。</li>
<li class="warn">ブラウザが Safari の場合、7 日間ページへの操作がないと計画が削除されます。7 日以内にページを再読み込みするようにしてください。計画が消えると困る場合は、画面キャプチャやコピーを取ってください。</li>
</ul>
</div>

</div>


<script type="text/javascript"><!--
const localStoragyKey = "keikaku";
const data = {  // 宿題データ
  "date-start": "2025-10-28", "date-end": "2025-10-31",
  "hw-1-name": "けいド", "hw-1-start": 0, "hw-1-end": 0,
  "hw-2-name": "かんド", "hw-2-start": 11, "hw-2-end": 13,
  "hw-3-name": "かんノ", "hw-3-start": 14, "hw-3-end": 16,
  "hw-4-name": "", "hw-4-start": 0, "hw-4-end": 0,
};
const dataKeikaku = {};  // 計画日データ
const tblKeikaku = document.getElementById("table-keikaku");
const tblYotei = document.getElementById("table-yotei");
const tabItems = document.querySelectorAll(".tab-item");
const dows = ["日", "月", "火", "水", "木", "金", "土",];

tabItems.forEach((tabItem) => {  // タブ切り替えイベントの設定
  tabItem.addEventListener("click", () => {
    tabItems.forEach((t) => { t.classList.remove("active"); });
    const tabPanels = document.querySelectorAll(".tab-panel");
    tabPanels.forEach((tabPanel) => { tabPanel.classList.remove("active"); });
    tabItem.classList.add("active");
    const tabIndex = Array.from(tabItems).indexOf(tabItem);
    tabPanels[tabIndex].classList.add("active");
  });
});

function getTargetPages() {  // 宿題データから対象ページを取得
  const pages = [];
  for (let i = 1; i <= 4; i++) {
    const start = parseInt(data[`hw-${i}-start`]);
    const end = parseInt(data[`hw-${i}-end`]);
    if (data[`hw-${i}-name`] == "" || start == 0 || start > end) {
      continue;
    }
    let page = start;
    while (page <= end) {
      pages.push([i, data[`hw-${i}-name`], page]);
      page += 1;
    }
  }
  return pages;
}

function loadLocalStorage() {  // ローカルストレージをロード
  dataLocal = JSON.parse(localStorage.getItem(localStoragyKey)) || {};
  Object.keys(data).forEach(key => {  // 宿題データがあればロード
    if (key in dataLocal) data[key] = dataLocal[key];
    document.getElementById(key).value = data[key];
  });
  const pages = getTargetPages();  // 宿題データから対象ページを取得
  pages.forEach(([i, _, page]) => {  // 対象ページの計画があればロード
    const selectId = `date-${i}-${page}`;
    if (selectId in dataLocal) {
      dataKeikaku[selectId] = dataLocal[selectId];
    }
  });
}

function dumpLocalStorage() {  // ローカルストレージにダンプ
  const dataKeikakuStore = {};  // 最新の対象ページの計画のみダンプ
  const pages = getTargetPages();
  pages.forEach(([i, _, page]) => {
    const selectId = `date-${i}-${page}`;
    dataKeikakuStore[selectId] = dataKeikaku[selectId];
  });
  localStorage.setItem(localStoragyKey, JSON.stringify({ ...data, ...dataKeikakuStore }));
}

function formatDate(date) {
  return `${date.toISOString().slice(0, 10)} (${dows[date.getDay()]})`;
}

function createSelectDate(dateStart, dateEnd, selectId) {  // 日付セレクト要素の作成
  const sl = document.createElement("select");
  sl.setAttribute("id", selectId);
  let date = new Date(dateStart);
  while (date < dateEnd) {  // 提出日の手前まで
    let dateFormatted = formatDate(date);
    let op = document.createElement("option");
    op.value = dateFormatted;
    op.innerText = dateFormatted;
    sl.appendChild(op);
    date.setDate(date.getDate() + 1);
  }
  let assigned = false;
  if (selectId in dataKeikaku) {  // このページの日付が計画済みであったとき
    const dateStored = new Date(dataKeikaku[selectId].replace(/\s*\(.+\)/, ""));
    if (dateStored < dateStart) {  // 開始日より手前であったら開始日に上書き
      dataKeikaku[selectId] = formatDate(dateStart);
    } else if (dateStored >= dateEnd) {  // 提出日以降であったら提出日前日に上書き
      dateStored.setDate(dateEnd.getDate() - 1);
      dataKeikaku[selectId] = formatDate(dateStored);
    }
    assigned = true;
  }
  if (!assigned) {  // 計画済みでなかったら開始日にしておく
    dataKeikaku[selectId] = formatDate(dateStart);
  }
  sl.value = dataKeikaku[selectId];  // 計画日を選択しておく
  sl.addEventListener('input', inputChangeKeikaku);
  return sl;
}

function createTableKeikaku() {  // 計画テーブルを作成
  tblKeikaku.innerHTML = "";
  if (data["date-start"] >= data["date-end"]) {
    tblKeikaku.innerHTML = "開始日は提出日より前の日付にしてください。";
    return;
  }
  const dateStart = new Date(data["date-start"]);
  const dateEnd = new Date(data["date-end"]);
  const pages = getTargetPages();
  pages.forEach(([i, name, page]) => {
      const tr = document.createElement("tr");
      const td0 = document.createElement("td");
      const td1 = document.createElement("td");
      const td2 = document.createElement("td");
      const selectId = `date-${i}-${page}`;
      td0.innerText = name;
      td0.classList.add(`hw-${i}`);
      td1.innerText = page;
      sl = createSelectDate(dateStart, dateEnd, selectId);
      td2.appendChild(sl);
      tr.appendChild(td0);
      tr.appendChild(td1);
      tr.appendChild(td2);
      tblKeikaku.appendChild(tr);
  });
}

function createTableYotei() {  // 予定テーブルを作成
  tblYotei.innerHTML = "";
  if (data["date-start"] >= data["date-end"]) {
    tblYotei.innerHTML = "開始日は提出日より前の日付にしてください。";
    return;
  }
  const pages = getTargetPages();
  const dateStart = new Date(data["date-start"]);
  const dateEnd = new Date(data["date-end"]);
  let date = new Date(dateStart);
  while (date <= dateEnd) {
    let dateFormatted = formatDate(date);
    const todayPages = pages.filter(([i, _, page]) => {
      return dataKeikaku[`date-${i}-${page}`] == dateFormatted;
    });
    const todayPageNames = todayPages.map(
      ([i, name, page]) => `<span class="hw hw-${i}">${name} ${page}</span>`
    );
    const tr = document.createElement("tr");
    const td0 = document.createElement("td");
    const td1 = document.createElement("td");
    td0.innerText = dateFormatted;
    td0.classList.add("date");
    if (date < dateEnd) {
      td1.innerHTML = todayPageNames.join(" ");
    } else {
      td1.innerHTML = "提出日";
      td1.classList.add("warn");
    }
    tr.appendChild(td0);
    tr.appendChild(td1);
    tblYotei.appendChild(tr);
    date.setDate(date.getDate() + 1);
  }
}

function inputChangeKeikaku(event) {  // 計画日データが変更されたときのイベントの設定
  dataKeikaku[event.target.id] = event.target.value;  // 計画日データを更新
  createTableYotei();  // 予定テーブルを作成
  dumpLocalStorage();  // ダンプ
}

function inputChange(event) {  // 宿題データが変更されたときのイベントの設定
  data[event.target.id] = event.target.value;  // 宿題データを変更
  createTableKeikaku();  // 計画テーブルを作成
  createTableYotei();  // 予定テーブルを作成
  dumpLocalStorage();  // ダンプ
}

Object.keys(data).forEach(key => {
  document.getElementById(key).addEventListener('input', inputChange);
});

document.addEventListener('DOMContentLoaded', () => {
  loadLocalStorage();  // ローカルストレージをロード
  createTableKeikaku();  // 計画テーブルを作成
  createTableYotei();  // 予定テーブルを作成
});
// --></script>
</body>
</html>
